var e,t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},n={};t.d(n,{ZU:()=>E,L8:()=>y,wk:()=>N,R9:()=>S});var o="undefined"==typeof document?void 0:document,i=!!o&&"content"in o.createElement("template"),r=!!o&&o.createRange&&"createContextualFragment"in o.createRange();function s(e,t){var n,o,i=e.nodeName,r=t.nodeName;return i===r||(n=i.charCodeAt(0),o=r.charCodeAt(0),n<=90&&o>=97?i===r.toUpperCase():o<=90&&n>=97&&r===i.toUpperCase())}function a(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var d={OPTION:function(e,t){var n=e.parentNode;if(n){var o=n.nodeName.toUpperCase();"OPTGROUP"===o&&(o=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==o||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}a(e,t,"selected")},INPUT:function(e,t){a(e,t,"checked"),a(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var o=e.firstChild;if(o){var i=o.nodeValue;if(i==n||!n&&i==e.placeholder)return;o.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,o,i=-1,r=0,s=e.firstChild;s;)if("OPTGROUP"===(o=s.nodeName&&s.nodeName.toUpperCase()))s=(n=s).firstChild;else{if("OPTION"===o){if(s.hasAttribute("selected")){i=r;break}r++}!(s=s.nextSibling)&&n&&(s=n.nextSibling,n=null)}e.selectedIndex=i}}};function l(){}function c(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}const h=function(t,n,a){if(a||(a={}),"string"==typeof n)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var h=n;(n=o.createElement("html")).innerHTML=h}else u=(u=n).trim(),n=i?function(e){var t=o.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(u):r?function(t){return e||(e=o.createRange()).selectNode(o.body),e.createContextualFragment(t).childNodes[0]}(u):function(e){var t=o.createElement("body");return t.innerHTML=e,t.childNodes[0]}(u);else 11===n.nodeType&&(n=n.firstElementChild);var u,f=a.getNodeKey||c,v=a.onBeforeNodeAdded||l,_=a.onNodeAdded||l,p=a.onBeforeElUpdated||l,m=a.onElUpdated||l,b=a.onBeforeNodeDiscarded||l,g=a.onNodeDiscarded||l,w=a.onBeforeElChildrenUpdated||l,E=a.skipFromChildren||l,y=a.addChild||function(e,t){return e.appendChild(t)},N=!0===a.childrenOnly,S=Object.create(null),A=[];function C(e){A.push(e)}function T(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var o=void 0;t&&(o=f(n))?C(o):(g(n),n.firstChild&&T(n,t)),n=n.nextSibling}}function U(e,t,n){!1!==b(e)&&(t&&t.removeChild(e),g(e),T(e,n))}function R(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=f(t);n&&(S[n]=t),R(t),t=t.nextSibling}}function O(e){_(e);for(var t=e.firstChild;t;){var n=t.nextSibling,o=f(t);if(o){var i=S[o];i&&s(t,i)?(t.parentNode.replaceChild(i,t),H(i,t)):O(t)}else O(t);t=n}}function H(e,t,n){var i=f(t);if(i&&delete S[i],!n){var r=p(e,t);if(!1===r)return;if(r instanceof HTMLElement&&R(e=r),function(e,t){var n,o,i,r,s=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var a=s.length-1;a>=0;a--)o=(n=s[a]).name,i=n.namespaceURI,r=n.value,i?(o=n.localName||o,e.getAttributeNS(i,o)!==r&&("xmlns"===n.prefix&&(o=n.name),e.setAttributeNS(i,o,r))):e.getAttribute(o)!==r&&e.setAttribute(o,r);for(var d=e.attributes,l=d.length-1;l>=0;l--)o=(n=d[l]).name,(i=n.namespaceURI)?(o=n.localName||o,t.hasAttributeNS(i,o)||e.removeAttributeNS(i,o)):t.hasAttribute(o)||e.removeAttribute(o)}}(e,t),m(e),!1===w(e,t))return}"TEXTAREA"!==e.nodeName?function(e,t){var n,i,r,a,l,c=E(e,t),h=t.firstChild,u=e.firstChild;e:for(;h;){for(a=h.nextSibling,n=f(h);!c&&u;){if(r=u.nextSibling,h.isSameNode&&h.isSameNode(u)){h=a,u=r;continue e}i=f(u);var _=u.nodeType,p=void 0;if(_===h.nodeType&&(1===_?(n?n!==i&&((l=S[n])?r===l?p=!1:(e.insertBefore(l,u),i?C(i):U(u,e,!0),i=f(u=l)):p=!1):i&&(p=!1),(p=!1!==p&&s(u,h))&&H(u,h)):3!==_&&8!=_||(p=!0,u.nodeValue!==h.nodeValue&&(u.nodeValue=h.nodeValue))),p){h=a,u=r;continue e}i?C(i):U(u,e,!0),u=r}if(n&&(l=S[n])&&s(l,h))c||y(e,l),H(l,h);else{var m=v(h);!1!==m&&(m&&(h=m),h.actualize&&(h=h.actualize(e.ownerDocument||o)),y(e,h),O(h))}h=a,u=r}!function(e,t,n){for(;t;){var o=t.nextSibling;(n=f(t))?C(n):U(t,e,!0),t=o}}(e,u,i);var b=d[e.nodeName];b&&b(e,t)}(e,t):d.TEXTAREA(e,t)}R(t);var x,z,L=t,k=L.nodeType,I=n.nodeType;if(!N)if(1===k)1===I?s(t,n)||(g(t),L=function(e,t){for(var n=e.firstChild;n;){var o=n.nextSibling;t.appendChild(n),n=o}return t}(t,(x=n.nodeName,(z=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==z?o.createElementNS(z,x):o.createElement(x)))):L=n;else if(3===k||8===k){if(I===k)return L.nodeValue!==n.nodeValue&&(L.nodeValue=n.nodeValue),L;L=n}if(L===n)g(t);else{if(n.isSameNode&&n.isSameNode(L))return;if(H(L,n,N),A)for(var V=0,D=A.length;V<D;V++){var M=S[A[V]];M&&U(M,M.parentNode,!1)}}return!N&&L!==t&&t.parentNode&&(L.actualize&&(L=L.actualize(t.ownerDocument||o)),t.parentNode.replaceChild(L,t)),L},u={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let f;const v=new Uint8Array(16);function _(){if(!f){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");f=crypto.getRandomValues.bind(crypto)}return f(v)}const p=[];for(let e=0;e<256;++e)p.push((e+256).toString(16).slice(1));const m=function(e,t,n){if(u.randomUUID&&!t&&!e)return u.randomUUID();const o=(e=e||{}).random||(e.rng||_)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return(p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]).toLowerCase()}(o)};class b extends HTMLElement{}customElements.define("reactor-viewport",b);class g{_id;_state;_render;_viewport;_container;_root;_emit=new Map;_http=new Map;_globalEvents=new Map;_localEvents=new Map;_debug;_resizeObserver;_resizeUserHandler;_dommode;_deferredRedraw=!1;constructor(e){if(this._id=m(),this._state=e.initialState,this._render=e.render,this._viewport=document.createElement("reactor-viewport"),this._viewport.classList.add("viewport"),this._viewport.dataset.id=this._id,e.id&&(this._viewport.id=e.id),this._dommode=e.dommode||"shadow",this._container="shadow"===this._dommode?this._viewport.attachShadow({mode:"closed",clonable:!0,delegatesFocus:!0}):this._viewport,this._root=this._render(this._state),this._container.appendChild(this._root),e.styles&&(this._container instanceof ShadowRoot?this._container.adoptedStyleSheets.push(e.styles):document.adoptedStyleSheets.push(e.styles)),this._debug=!!e.debug,this._globalEventHandler=this._globalEventHandler.bind(this),this._localEventHandler=this._localEventHandler.bind(this),this._resizeHandler=this._resizeHandler.bind(this),e.events)for(const t in e.events)Object.hasOwn(e.events,t)&&("function"==typeof e.events[t]?this._localEvents.set(t,{handler:e.events[t]}):Object.hasOwn(e.events[t],"target")&&"local"!==e.events[t].target?this._globalEvents.set(t,{handler:e.events[t].handler,options:e.events[t].options}):this._localEvents.set(t,{handler:e.events[t].handler,options:e.events[t].options}));if(e.emit)for(const t of e.emit)this._emit.set(t.when,new Set(Array.isArray(t.emit)?t.emit:[t.emit]));if(e.http)for(const t of e.http)this._http.set(t.when,new Set(Array.isArray(t.send)?t.send:[t.send]));for(const e of this._localEvents.keys())this._container.addEventListener(e,this._localEventHandler,this._localEvents.get(e).options||!0);for(const e of this._globalEvents.keys())window.addEventListener(e,this._globalEventHandler,this._globalEvents.get(e).options||!0);e.onResize&&(this._resizeUserHandler=e.onResize,this._resizeObserver=new ResizeObserver(this._resizeHandler),this._resizeObserver.observe(this._viewport)),this._sendRequests(null)}destructor(){for(const e of this._localEvents.keys())this._container.removeEventListener(e,this._localEventHandler,this._localEvents.get(e).options||!0);for(const e of this._globalEvents.keys())window.removeEventListener(e,this._globalEventHandler,this._globalEvents.get(e).options||!0);this._resizeObserver&&this._resizeObserver.unobserve(this._viewport)}_resizeHandler(e){this._changeState(this._resizeUserHandler(this._state,e))}_localEventHandler(e){this._debug&&console.log("nikonov-components: local event catch",e),["submit"].includes(e.type)&&e.preventDefault(),e.stopImmediatePropagation();const t=this._localEvents.get(e.type).handler;this._changeState(t(this._state,e))}_globalEventHandler(e){this._debug&&console.log("nikonov-components: global event catch",e);const t=this._globalEvents.get(e.type).handler;this._changeState(t(this._state,e))}_redraw(){const e=this._render(this._state);this._debug&&console.log("nikonov-components: redraw",this._root.cloneNode(!0),e.cloneNode(!0)),this._root.isEqualNode(e)||(this._root.nodeName!==e.nodeName?(this._root.replaceWith(e),this._root=e):h(this._root,e,{getNodeKey:e=>e instanceof b?e.dataset.id:e.id,onBeforeNodeAdded:e=>(this._debug&&console.log("nikonov-components: element added",e.cloneNode(!0)),e instanceof b&&e.classList.contains("stub")?e.reference.deref():e),onBeforeElUpdated:(e,t)=>(this._debug&&console.log("nikonov-components: element update",e.cloneNode(!0),t.cloneNode(!0)),!e.isEqualNode(t)&&(t instanceof b?t.dataset.id!==e.dataset.id&&(t.classList.contains("viewport")?t:(e.replaceWith(t.reference.deref()),!1)):e))}))}_emitEvents(e){for(let[t,n]of this._emit)if(t(e,this._state))for(let e of n)this._viewport.dispatchEvent(e(this._state))}_sendRequests(e){for(let[t,n]of this._http)if(t(e,this._state))for(let e of n){const t=("function"==typeof e?e:e.request)(this._state),n=fetch(t);"function"!=typeof e&&n.then((t=>{Object.hasOwn(e,"text")?t.text().then((t=>this._changeState(e.text(this._state,t)))):t.json().then((t=>this._changeState(e.json(this._state,t))))}))}}_changeState(e){if(this._state===e)return;const t=this._state;this._state=e,this._deferredRedraw||(setTimeout((()=>{this._redraw(),this._deferredRedraw=!1}),0),this._deferredRedraw=!0),this._emitEvents(t),this._sendRequests(t),this._debug&&console.log("nikonov-components: transition from",t,"to",this._state)}}const w=new FinalizationRegistry((e=>{e._debug&&console.log("nikonov-components gc:",e._id,JSON.parse(JSON.stringify(e._state))),e.destructor()}));class E{_core;constructor(e){this._core=new g(e),w.register(this,this._core)}}const y=e=>new E(e),N=e=>e._core._state,S=e=>{if(!e._core._viewport.isConnected)return e._core._viewport;const t=document.createElement("reactor-viewport");return t.classList.add("stub"),t.dataset.id=e._core._id,t.reference=new WeakRef(e._core._viewport),t};var A=n.ZU,C=n.L8,T=n.wk,U=n.R9;export{A as Type,C as make,T as state,U as viewport};